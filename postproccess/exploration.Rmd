---
title: "JF_processing"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=F, warning=F}

knitr::opts_chunk$set(echo = TRUE)




library(tidyverse)
library(lubridate)
library(chron)
library(formattable)
library(gridExtra)
library(kableExtra)
library(RHESSysIOinR)
library(data.table)
library(stringr)
library(beepr)
# function used to aggregate daily data to water year
# many of the relationships we are interested in can't be seen if we look at daily output
# because of time lags - aggregating by water year makes many of these more visible
# note relationships are also "better" if we use water year rather than calendar year
# because of the time lags and  seasonality of precipitation and active growing season
resthinagg2 = function(resthin.tmp) {
  
  # note that for stores (plantc) we use average
  # for fluxes (et, watertransfer, evap, trans, psn) we use sum
  # for some variables we look at annual maximum (pkswe) and maxcpool 
resthin.tmp.wy = resthin.tmp %>% 
  group_by(scen,climproj,wy,thin) %>% 
  dplyr::summarize(
         plantc=mean(plantc, na.rm=T),
         stemc_live= mean(stemc_live),
         stemc_dead=mean(stemc_dead),
         lai=mean(lai),
         trans=sum(trans),
         evap=sum(evap), 
         gpsn=sum(gpsn), 
         resp=sum(resp), 
         precip=sum(precip),
         maxcpool=max(cpool),
         streamflow=sum(streamflow),
         tmin=min(tmin),
         tmax=max(tmax),
         tmin_avg=mean(tmin),
         tmax_avg=mean(tmax)
         ) %>% 
  ungroup()

resthin.tmp.wy$et = resthin.tmp.wy$evap+resthin.tmp.wy$trans
# pcpool is an indicator of drought stress (what percent of the plant carbon is in stored
# carbohydrate (cpool)
resthin.tmp.wy$pcpool = with(resthin.tmp.wy, ifelse(plantc > 0, maxcpool/plantc,0))

# design a variable to track how long its been since the 'thinning' even occured
resthin.tmp.wy = mutate(resthin.tmp.wy, wyg=wy-scen)


return(resthin.tmp.wy)
} 


### function for simulating thinning
init_thin <- function (thin) {
  
  # define proportions
  c <- thin
  t <- 1 - thin
  
  thinned <- data %>% 
    dplyr::filter(canopy == 'thin')
  
  control <- data  %>% 
    dplyr::filter(canopy == 'control')
   
  both <- data.frame(matrix(nrow = nrow(thinned), ncol = length(thinned)+1))
  names(both) <- c(names(thinned), 'thin')
  
  both$evap <- thinned$evap*t + control$evap*c
  both$trans <- thinned$trans*t +  control$trans*c
  both$gpsn <- thinned$gpsn*t + control$gpsn*c
  both$resp <- thinned$resp*t + control$resp*c
  both$lai <- thinned$lai*t +  control$lai*c
  both$cpool <- thinned$cpool*t + control$cpool*c
  both$plantc <- thinned$plantc*t + control$plantc*c
  both$stemc_live <- thinned$stemc_live*t + control$stemc_live*c
  both$stemc_dead <- thinned$stemc_dead*t + control$stemc_dead*c
  both$streamflow <- thinned$streamflow*t + control$streamflow*c
  both$thin <- thin*100
  both$wyg <- thinned$wyg
  both$climproj <- thinned$climproj
  both$level <- thinned$level
  both$scen <- thinned$scen
  both$year <- thinned$year
  both$month <- thinned$month
  both$day <- thinned$day
 
  
  return(both)
}



```



```{r preprocessing, include=F}

### read in climate projection runs
#create list of file suffixes for reading in with for loop
climscen <- c('rcp45-Had', 'rcp45-MIROC', 'rcp45-CNRM', 'rcp45-CAN', 'rcp85-Had', 'rcp85-MIROC', 'rcp85-CNRM', 'rcp85-CAN', 'historic')

# read in the data
for (i in 1:length(climscen)) {
  
  data <- read.table(sprintf('/Users/kmonper/Google Drive/JDSF/rhessys/out/JF_thin-proj-%s', climscen[i]), header = T)
  data <- select(data, -thin)
  #perform thinning
  tmp <- lapply(seq(0,1,.2), init_thin)
  thinned <- rbindlist(tmp)
  
  date <- mkdate(thinned)
  res <- resthinagg2(date)
  
  if (str_detect(climscen[i], '45')) {
    res$level <- 'RCP-45'
  } else if(str_detect(climscen[i], '85')) {
    res$level <- 'RCP-85'
  } else {
    res$level <- 'historic'
  }
  
  
  if (i == 1) {
  thin_full <- res
  } else {
    thin_full <- bind_rows(thin_full, res)
    }
  
  rm(res, tmp, data, date, thinned)
  print(i)
}


# subset data by projection level
rcp45 <- dplyr::filter(thin_full, level == 'RCP-45')
rcp85 <- dplyr::filter(thin_full, level == 'RCP-85')


```



```{r read climate data, include = F}
###
# clim file names
clim <- c('rcp45-Had', 'rcp45-MIROC', 'rcp45-CAN', 'rcp45-CNRM', 'rcp85-Had', 'rcp85-MIROC', 'rcp85-CAN', 'rcp85-CNRM', 'JF')

for (i in 1:length(clim)) {
  # read in data
  tmp = read_rhessys_met(sprintf("/Users/kmonper/Google Drive/JDSF/rhessys/clim/%s", clim[i]))
  # id projection
  tmp$climproj <- clim[i]
  
  if (str_detect(clim[i], '45')) {
    tmp$level <- 'rcp-4.5'
  } else if (str_detect(clim[i], '85')) {
    tmp$level <- 'rcp-8.8'
  } else {
    tmp$level <- 'historic'
  }
  
  if (i ==1) { 
    met <- tmp
  } else {
      met <- bind_rows(met, tmp)
    }
}
```



```{r ColorScales, echo = F}
cc <- scales::seq_gradient_pal("grey", "darkblue", "Lab")(seq(0,1,length.out=length(unique(thin_full$thin))))
cc[6] <- "red"
lbs <- as.character(unique(thin_full$thin))
lbs[lbs==100] <- "Control"

theme_set(theme_bw())
```
  

***  
 ----  

## Carbon



```{r stem carbon, echo = F}
stemc <- thin_full %>% 
  group_by(wyg, thin, level) %>% 
  summarise(
    mean = mean(stemc_live),
    sd = sd(stemc_live)
  )

stemc_plot <- ggplot(stemc, aes(x=wyg, y=mean, group = level, fill = level)) +
  geom_line() +
  geom_hline(yintercept = stemc$mean[stemc$thin==100 & stemc$wyg == 0], color = 'darkgreen', size = 1) + 
  facet_wrap(~thin) +
  geom_ribbon(aes(ymin=mean-2*sd, ymax=mean+2*sd), alpha = .3) +
  labs(
    x = 'years after thin',
    y = 'stem carbon',
    title = 'change in live stem carbon over time by thinning %'
  )
stemc_plot
```


```{r, echo = F}
thin_full$stemc_total <- thin_full$stemc_dead+thin_full$stemc_live

stemc_tot <- thin_full %>% 
  group_by(wyg, thin, level) %>% 
  summarise(
    mean = mean(stemc_total),
    sd = sd(stemc_total)
  )

stemc_plot <- ggplot(stemc_tot, aes(x=wyg, y=mean, group = level, fill = level)) +
  geom_line() +
  geom_hline(yintercept = stemc_tot$mean[stemc_tot$thin==100 & stemc_tot$wyg == 0], color = 'darkgreen', size = 1) + # do we want to visually compare against starting value of the control, or the mean, or...?
  facet_wrap(~thin) +
  geom_ribbon(aes(ymin=mean-2*sd, ymax=mean+2*sd), alpha = .3) +
  labs(
    x = 'years after thin',
    y = 'stem carbon',
    title = 'change in TOTAL stem carbon over time by thinning %'
  )
# stemc_plot

```
  

```{r, echo = F}
flux <- thin_full %>% 
  group_by(wyg, thin, climproj) %>% 
  summarise(
    mean = mean(stemc_total),
    sd = sd(stemc_total)
  )

ggplot(flux, aes(wyg, mean, group = as.factor(thin), fill = as.factor(thin))) +
  geom_line() +
  facet_wrap(~climproj) +
  geom_ribbon(aes(ymin=mean-2*sd, ymax=mean+2*sd), alpha = .3)  +
  labs(
    x = 'years after thin',
    y = 'stem carbon',
    title = 'change in total stem carbon over time by model'
  )
```
    
   -----  
##### explaining the high variation within the early years for the two plots above:
```{r,  include = F}
# get summary met data for each year
met_sum <- met %>% 
  group_by(climproj, wy) %>% 
  summarise(
    tmin = min(tmin),
    tmax = max(tmax),
    tavg = (tmin+tmax)/2,
    rain = sum(rain)
  ) %>% 
  ungroup()

#select variables and join with  thin_full
clim <- select(met_sum, tmin, tmax, tavg, rain, wy, climproj)  

thin_full_clim <- left_join(select(thin_full, -tmin, -tmax), 
                            clim, 
                            by = c('wy', 'climproj'))

# summarise by scenario and calculate percent change for each year
test <- thin_full_clim %>% 
  ungroup() %>% 
  filter(climproj == 'rcp85-CAN' & thin == 100) %>% 
  select(scen, stemc_total, wyg, tavg) %>% 
  group_by(scen) %>% 
  mutate(pct_change = stemc_total/lag(stemc_total,1))

all <- na.omit(test)

```
  
```{r}

ggplot(all, aes(x = tavg, y = pct_change, color = wyg)) +
  geom_point() + 
  facet_wrap(~scen) +
  labs(
    title = 'effect of starting year and average temperature on annual %change in stemc \n within control treatment (rcp 8.5 CAN)',
    x = 'yearly average temperature (C)',
    y = 'annual percent change in stemc'
  )
```
  

#####  Note that as the starting year (scenario) increases, we see that the largest percent increase in stemc see in the years just after harvest, along with an upwards shift in the minimum average temperatures. This may explain the initial large standard deviations within the some of the above figures.  
    
##### This trend is less pronounced when considering models that have less variability in their effect on stemc over time. i.e:
  
```{r}

# summarise by scenario and calculate percent change for each year
test <- thin_full_clim %>% 
  ungroup() %>% 
  filter(climproj == 'rcp45-CNRM' & thin == 100) %>% 
  select(scen, stemc_total, wyg, tavg) %>% 
  group_by(scen) %>% 
  mutate(pct_change = stemc_total/lag(stemc_total,1))

all <- na.omit(test)


```
  
```{r}

ggplot(all, aes(x = tavg, y = pct_change, color = wyg)) +
  geom_point() + 
  facet_wrap(~scen) +
  labs(
    title = 'starting year and average temperature on annual %change in stemc \n within control treatment (rcp 4.5 CNRM) ',
    x = 'yearly average temperature (C)',
    y = 'annual percent change in stemc'
  )

```


```{r temperate comparison, echo = F}
tmp <- thin_full_clim %>% 
  ungroup() %>% 
  filter(thin == 100 &
           climproj %in% c('rcp45-CNRM', 'rcp85-CAN') &
           scen == 2030) %>% 
  select(climproj, wy, tmin, tmax, tavg) %>% 
  gather(value, number, -climproj, -wy)

ggplot(tmp, aes(wy, number, color = climproj)) +
  geom_line(aes(linetype = value)) +
  labs(x = 'water year',
        y = 'temperature (C)',
       title = 'variation in temperature between models with the most and least \n  variation in stemc across scenarios')
```
  
  
 ----  
 
 ##### total plant carbon (Kg/m2) for each climate scenario based on thinning. precip is cumulative across all 100 years
```{r, echo=F, warning=F, message=F}
summary <- flux %>% 
  ungroup() %>% 
  filter(wyg == 79) %>% 
  mutate(mean = round(mean/1000,0)) %>% 
  select(-wyg, -sd) %>% 
  spread(thin, mean) %>% 
  arrange(-`100`)

met_sum <- met %>% 
  group_by(climproj) %>% 
  summarise(
    total_precip = sum(rain)
  )
met_sum$climproj[met_sum$climproj == 'JF'] <- 'historic'

ext <- left_join(summary, met_sum)

kable(ext) %>% 
  kable_styling()
```  
  
##### number of years until stemc returns to 90% of original levels for each model and thinning treatment
```{r time until return, echo = F, warning = F}
tmp <- flux %>% 
  ungroup() %>% 
  filter(wyg == 0, thin == 100) %>% 
  select(climproj, mean) %>% 
  mutate(target = mean*.9)


thin <- unique(flux$thin)

res <- data.frame()
res[1:9,1] <- climscen
for (i in 1:length(climscen)) {
  for (j in 1:length(thin)) {
   
  target <- tmp$target[tmp$climproj == climscen[i]]
  res[i,j+1] <- min(flux$wyg[flux$climproj == climscen[i] & flux$thin == thin[j] & flux$mean >= target])  
     
  }
}
names(res) <- c('climproj', thin)

for (i in 1:length(res)) {
  res[,i][res[,i] == Inf] <- '>99'
}

kable(res) %>% 
  kable_styling()

rm(tmp, target)
```




***
 ----

## streamflow
  

```{r, echo = F}
thin_sub <- c(0,100)

stream45 <- filter(rcp45, thin %in% thin_sub)

ggplot(stream45, aes(x = wyg, y = streamflow, levels = thin, color = as.factor(thin))) +
  geom_line() +
  facet_wrap(~climproj) +
  labs(title = 'rcp 4.5')
```

```{r, echo = F}

stream85 <- filter(rcp85, thin %in% thin_sub)

ggplot(stream85, aes(x = wyg, y = streamflow, levels = thin, color = as.factor(thin))) +
  geom_line() +
  facet_wrap(~climproj) +
  labs(title = 'rcp 8.5')
```
  
  
 ----  
   
#### exploring the reason for streamflow going to 0: 
* Things to explore here: 
1. overlay precipitation w/ ET. 
     + also: check the number of years that et > precip 
2. next step could be to look at groundwater to try to figure out where else the water might be going

```{r, echo = F}
tmp <- thin_full_clim %>% 
  ungroup() %>% 
  filter(scen == 2030 & thin == 100 & climproj != 'historic') %>% 
  select(rain, et, wy, streamflow, climproj)
  
ggplot(tmp, aes(wy)) +
  geom_line(aes(y = rain, colour = 'precip')) +
  geom_line(aes(y = et, colour = 'et')) +
  scale_color_manual(name = '', values = c('precip' = 'black', 'et'= 'red')) +
  facet_wrap(~climproj)

```
  ***  
    
##### ugly figure. BUT we can see that the models that have more years where et > rain (y = -1) are the same ones with lower stream flows
```{r graph et diff, echo = F}
tmp$dif <- ifelse(tmp$et > tmp$rain, -1, 1)

ggplot(tmp, aes(wy, dif)) +
  geom_col() +
  facet_wrap(~climproj) +
  labs(
    title = 'cases where ET exceeds rain',
    x = 'water year',
    y = '1 = rain > et; -1 rain < et'
  )
```
  
  
#####  can also count how many years that et > rain for each model. once again, the models where stream flow drops to 0 (namely MIROC [rcp 4.5 & 8.5] & to some degree, rcp 4.5 Had) are the ones with the highest number of years where et > precip

```{r et counts, echo = F, fig.width=4}
tmp$count <- ifelse(tmp$rain < tmp$et, 1, 0)

summary <- tmp %>% 
  group_by(climproj) %>% 
  summarise(
    count = sum(count)
  ) %>% 
  arrange(-count)

kable(summary) %>% 
  kable_styling()
```











